<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Product Catalog</title>

  <!-- Manifest for Add to Home Screen -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f1724" />

  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.08)}
    html,body{
      height:100%;margin:0;
      background:linear-gradient(180deg,#021124 0%, #071326 100%);
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
      color:#e6eef6;font-size:15px;
    }
    .wrap{max-width:100%;margin:0 auto;padding:12px}
    h1{text-align:center;font-size:1.2rem;margin:0 0 10px}
    .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 3px 12px rgba(0,0,0,0.5);}
    .controls{display:flex;flex-direction:column;gap:10px}
    .btn{background:linear-gradient(90deg,var(--accent),#7dd3fc);border:none;
      padding:10px;border-radius:10px;color:#021124;font-weight:600;
      cursor:pointer;font-size:1rem;text-align:center}
    input[type="file"]{display:none}
    .search{position:relative}
    .search input{
      width:100%;padding:14px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,0.1);
      background:var(--glass);color:inherit;font-size:1.1rem;
    }
    .suggestions{position:absolute;top:100%;left:0;right:0;background:var(--card);
      border-radius:10px;margin-top:4px;box-shadow:0 6px 12px rgba(0,0,0,0.5);
      max-height:240px;overflow-y:auto;z-index:100}
    .suggestion-item{padding:10px;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.05);font-size:1rem}
    .suggestion-item:hover{background:rgba(6,182,212,0.15)}
    .suggestion-qty{float:right;color:var(--muted)}
    mark{background:rgba(6,182,212,0.4);color:#fff;border-radius:3px;padding:0 2px}
    .meta{margin-top:10px;color:var(--muted);font-size:0.85rem;text-align:center}
    .table-wrap{margin-top:14px}
    table{width:100%;border-collapse:collapse;font-size:0.9rem}
    th,td{padding:8px 6px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.05)}
    th{color:var(--muted);font-weight:600;position:sticky;top:0;background:var(--card);z-index:1}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,0.1);font-size:0.8rem;color:var(--muted)}
    .footer{margin:14px 0 0;text-align:center;font-size:0.75rem;color:var(--muted)}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Product Catalog</h1>

    <div class="card">
      <div class="controls">
        <label id="upload-label" class="btn">Upload File
          <input id="file-input" type="file" accept=".xlsx,.xls,.csv" />
        </label>
        <button id="upload-again" class="btn" style="display:none">Upload Again</button>
        <div class="search">
          <input id="search-box" placeholder="ðŸ” Search products..." />
          <div id="suggestions" class="suggestions" style="display:none"></div>
        </div>
      </div>

      <div class="meta" id="file-meta">No file loaded.</div>

      <div class="table-wrap card" style="margin-top:12px;">
        <span class="tag" id="rows-count">0 rows</span>
        <div style="overflow:auto;max-height:400px;margin-top:10px;">
          <table id="data-table"><thead></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
    <div class="footer">Mobile Catalog App</div>
  </div>

<script>
let rawData = [], headers = [], fuse = null;
const qtyColumn = 'Available physical';
const fileInput = document.getElementById('file-input');
const uploadLabel = document.getElementById('upload-label');
const uploadAgain = document.getElementById('upload-again');
const searchBox = document.getElementById('search-box');
const suggestionsBox = document.getElementById('suggestions');
const fileMeta = document.getElementById('file-meta');
const rowsCount = document.getElementById('rows-count');
const dataTable = document.getElementById('data-table');

fileInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const buffer = await f.arrayBuffer();
  const workbook = XLSX.read(buffer, {type:'array'});
  const sheetName = workbook.SheetNames[0];
  const worksheet = workbook.Sheets[sheetName];
  const json = XLSX.utils.sheet_to_json(worksheet, {defval:'', header:1});
  if(json.length<=1){ fileMeta.textContent='No rows found'; return; }

  headers = json[0];
  rawData = json.slice(1).map(row => Object.fromEntries(headers.map((h,i)=>[h,row[i]])));

  fileMeta.textContent = `${f.name} â€” ${rawData.length} rows`;
  rowsCount.textContent = `${rawData.length} rows`;

  const productHeader = headers[1];
  fuse = new Fuse(rawData, {keys:[productHeader], threshold:0.4});
  renderTable(rawData.slice(0,100));

  uploadLabel.style.display = 'none';
  uploadAgain.style.display = 'block';
});

uploadAgain.addEventListener('click', ()=>{
  fileInput.value = '';
  uploadLabel.style.display = 'block';
  uploadAgain.style.display = 'none';
  fileMeta.textContent = 'No file loaded.';
  rowsCount.textContent = '0 rows';
  dataTable.querySelector('thead').innerHTML = '';
  dataTable.querySelector('tbody').innerHTML = '';
  rawData = [];
  headers = [];
});

searchBox.addEventListener('input', debounce(()=>{
  const q = searchBox.value.trim();
  if(!q){ suggestionsBox.style.display='none'; renderTable(rawData.slice(0,100)); return; }
  const productHeader = headers[1];
  const results = fuse.search(q, {limit:20});
  if(results.length===0){ suggestionsBox.style.display='none'; return; }
  suggestionsBox.innerHTML = results.map(r=>{
    const name = r.item[productHeader];
    const qty = r.item[qtyColumn] || 0;
    return `<div class="suggestion-item" data-name="${escapeHtml(name)}">${highlightMatch(escapeHtml(name), q)} <span class="suggestion-qty">Qty: ${qty}</span></div>`;
  }).join('');
  suggestionsBox.style.display='block';
}));

suggestionsBox.addEventListener('click', (e)=>{
  const div = e.target.closest('.suggestion-item');
  if(!div) return;
  const name = div.getAttribute('data-name');
  const productHeader = headers[1];
  const match = rawData.filter(r=>String(r[productHeader])===name);
  renderTable(match);
  suggestionsBox.style.display='none';
  searchBox.value = name;
});

function renderTable(rows){
  const thead = dataTable.querySelector('thead');
  const tbody = dataTable.querySelector('tbody');
  thead.innerHTML = '';
  tbody.innerHTML = '';
  if(!rows || rows.length===0){ thead.innerHTML='<tr><th>No results</th></tr>'; rowsCount.textContent='0 rows'; return; }

  const productHeader = headers[1];
  let cols = Object.keys(rows[0]).slice(0,15);
  cols = [productHeader, ...cols.filter(c => c !== productHeader)];
  if(!cols.includes(qtyColumn)) cols.push(qtyColumn);

  thead.innerHTML = '<tr>' + cols.map(c=>`<th>${escapeHtml(c)}</th>`).join('') + '</tr>';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = cols.map(c=>`<td>${escapeHtml(String(r[c]||''))}</td>`).join('');
    tbody.appendChild(tr);
  });
  rowsCount.textContent = `${rows.length} rows`;
}

function escapeHtml(s){ return s.replace(/[&<>"]|'/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])) }
function highlightMatch(text, query){
  const re = new RegExp(`(${query})`,'gi');
  return text.replace(re,'<mark>$1</mark>');
}
function debounce(fn, delay=200){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),delay); };
}

// Register service worker for PWA
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
